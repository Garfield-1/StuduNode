# GNU make

参考文档

1. 《GNU make中文手册》																											整理翻译：徐海兵
2. 《跟我一起写Makefile》                            																                作者：陈皓

## 1. 概述

* make是一个在软件开发中所使用的工具程序（Utility software），经由读取“makefile”的文件以自动化建构软件。它是一种转化文件形式的工具，转换的目标称为“target”；与此同时，它也检查文件的依赖关系，如果需要的话，它会调用一些外部软件来完成任务。它的依赖关系检查系统非常简单，主要根据依赖文件的修改时间进行判断。大多数情况下，它被用来编译源代码，生成结果代码，然后把结果代码连接起来生成可执行文件或者库文件。它使用叫做“makefile”的文件来确定一个target文件的依赖关系，然后把生成这个target的相关命令传给shell去执行。
* 许多现代软件的开发中（如Microsoft Visual Studio），集成开发环境已经取代make，但是在Unix环境中，仍然有许多工程师采用make来协助软件开发。



### 1.1 GNU make介绍

* make在执行时，需要一个命名为Makefile的文件。这个文件告诉make以何种方式编译源代码和链接程序。如果在你的工程中已经存在一个或着多个正确的Makefile。当对工程中的若干源文件修改以后，需要根据修改来更新可执行文件或者库文件，make会自动根据修改情况完成源文件的对应.o文件的更新、库文件的更新、最终的可执行程序的更新。

#### 1.1.1 相关知识

* 链接：将多.o文件，或者.o文件和库文件链接成为可被操作系统执行的可执行程序(Linux环境下，可执行文件的格式为“ELF”格式)。链接器不检查函数所在的源文件，只检查所有.o文件中的定义的符号。将.o文件中使用的函数和其它.o或者库文件中的相关符号进行合并，对所有文件中的符号进行重新安排(重定位),并链接系统相关文件(程序启动文件等)最终生成可执行程序。链接过程使用`GNU`的`ld工具`。
* 静态库：又称为文档文件(Archive File)。它是多个.o文件的集合。Linux中静态库文件的后缀为“.a”。静态库中的各个成员(.o文件)没有特殊的存在格式，仅仅是一个.o文件的集合。

* 动态库：也是多个.o文件的集合，但是这些.o文件时有编译器按照一种特殊的方式生成(Linux中，共享库文件格式通常为“ELF”格式。共享库已经具备了可执行条件)。模块中各个成员的地址(变量引用和函数调用)都是相对地址。使用此共享库的程序在运行时，共享库被动态加载到内存并和主程序在内存中进行连接。多个可执行程序可共享库文件的代码段(多个程序可以共享的使用库中的某一个模块，共享代码，不共享数据)。



## 2. Makefile规则

* 当使用make工具进行编译时，工程中以下几种文件在执行make时将会被编译(重新编译):

  * 所有的源文件没有被编译过，则对各个C源文件进行编译并进行链接，生成最后的可执行程序；

  * 每一个在上次执行make之后修改过的C源代码文件在本次执行make时将会被重新编译；

  * 头文件在上一次执行make之后被修改。则所有包含此头文件的C源文件在本次执行make时将会被重新编译。

### 2.1 执行

* Makefile文件的执行需要安装先make工具，此文仅涉及GNU make；

* 执行Makefile文件时在终端输入对应命令

  ```makefile
  #自动执行名称为makefile.mk或者Makefile.mk的文件
  make
  
  #执行指定的mk文件
  make -f XXX.mk
  ```



### 2.2 文件结构

* makefile文件执行时会从从上向下的第一个目标开始

  ```makefile
  target:prerequisites
  	command
  	...
  	...
  ```

* `target:`规则的目标。通常是最后需要生成的文件名或者为了实现这个目的而必需的中间过程文件名。可以是.0文件、也可以是最后的可执行程序的文件名等。另外，目标也可以是一个make执行的动作的名称，如目标“clean”

* `prerequisites:`规则的依赖。生成规则目标所需要的文件名列表。通常一个目标依赖于一个或者多个文件。

* `command:`规则的命令行。是规则所要执行的动作(任意的shell命令或者是可在shell下执行的程序)。它限定了make执行这条规则时所需要的动作。

* 一个规则可以有多个命令行，每一条命令占一行。注意：命令行必须以`[Tab]字符`开始而不是四个空格，`[Tab]字符`告诉make此行是一个命令行。make按照命令完成相应的动作。这也是书写Makefile中容易产生，而且比较隐蔽的错误。



### 2.2 调试

* makefile文件中有几种添加打印或者断点的方式

  * error函数，产生一个致命的错误并中断执行

    ```makefile
    $(error error test)    		#error test
    ```

  * warining函数，产生一个告警的信息不影响执行

    ```makefile
    $(warning warning test)		#warning test
    ```

  * info函数，产生一个调试的信息不影响执行

    ```makefile
    $(info info test)			#info test
    ```

  * echo函数，调用shell中的echo函数打印调式信息

    ```makefile
    @echo "echo test"			#echo test
    ```

    

## 3. 流程控制语句

* **需要特别注意的时在一个目标内使用时，前面不可以有`[tab]符号`，否则会被认为是`shell语句`；相关语句会传给shell解释器使用shell语法解析，导致报错**

* ifeq函数，判断参数是否不相等；相等为 true，不相等为 false

  ```makefile
  ifeq ($(a), $(b))
  	@echo "a = b"
  else
  	@echo "a != b"
  endif
  ```

* ifneq函数，判断参数是否不相等；不相等为 true，相等为 false

  ```makefile
  ifneq ($(a), $(b))
  	@echo "a = b"
  else
  	@echo "a != b"
  endif
  ```

* ifdef函数，判断变量的值是不是为空；有值为 true，没有值为 false

  ```makefile
  ifdef v
  	@echo "a = b"
  else
  	@echo "a != b"
  endif
  ```

* ifndef函数，判断变量的值是不是为空；没有值为 true，有值为 false

  ```makefile
  ifndef v
  	@echo "a = b"
  else
  	@echo "a != b"
  endif
  ```

  

## 变量

## 目标

## 宏

## 规则

### 多规则目标

### 双冒号规则

## 函数

